<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>üöÄ Windows Command Launcher</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --accent-color: #1a73e8;
            --accent-hover: #1557b0;
            --input-bg: #ffffff;
            --border-color: #dddddd;
            --code-bg: #eceff1;
            --code-text: #546e7a;
            --highlight-bg: #fff59d;
            --btn-text: #ffffff;
            --fav-color: #ffb300;
        }

        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #9e9e9e;
            --accent-color: #90caf9;
            --accent-hover: #64b5f6;
            --input-bg: #2c2c2c;
            --border-color: #333333;
            --code-bg: #263238;
            --code-text: #b0bec5;
            --highlight-bg: #fbc02d;
            --btn-text: #000000;
        }

        html, body { 
            overflow: hidden; height: 100%; margin: 0; 
            background: var(--bg-color); color: var(--text-main);
            user-select: none; transition: background 0.3s ease;
        }
        ::-webkit-scrollbar { display: none; }

        body { font-family: 'Segoe UI', 'BIZ UDPGothic', sans-serif; padding: 20px; box-sizing: border-box; }
        .card { 
            height: 100%; max-width: 1000px; margin: 0 auto; 
            background: var(--card-bg); padding: 25px; 
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; box-sizing: border-box;
            border: 1px solid var(--border-color);
            position: relative;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; flex-shrink: 0;
            z-index: 10;
        }

        h1 { margin: 0; color: var(--accent-color); font-size: 1.3rem; }

        .theme-toggle {
            cursor: pointer; background: var(--input-bg); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem;
            font-weight: bold; transition: all 0.2s;
        }

        input { 
            width: 100%; padding: 12px; margin: 15px 0; 
            background: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--border-color); border-radius: 8px; 
            box-sizing: border-box; outline: none; flex-shrink: 0;
            z-index: 10; position: relative;
        }
        input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(144,202,249,0.2); }
        
        /* „ÉÜ„Éº„Éñ„É´„Ç≥„É≥„ÉÜ„Éä„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆö„ÇíÁ¢∫‰øù */
        .table-container { 
            flex-grow: 1; 
            overflow: hidden; 
            position: relative;
            z-index: 5;
        }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        .item-row td { padding: 12px 12px 2px 12px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥„ÇíÂ§ß„Åç„ÅèÊäº„Åó„ÇÑ„Åô„Åè */
        .fav-star {
            cursor: pointer;
            font-size: 1.4rem;
            margin-right: 8px;
            color: #ccc;
            transition: transform 0.1s ease, color 0.2s;
            display: inline-block;
            vertical-align: middle;
            padding: 2px 5px; /* „ÇØ„É™„ÉÉ„ÇØÈ†òÂüü„ÇíÊã°Â§ß */
        }
        .fav-star:hover { transform: scale(1.2); }
        .fav-star.active { color: var(--fav-color); }

        .cmd-row td { padding: 0 12px 12px 12px; border-bottom: 1px solid var(--border-color); }
        .cmd-code { 
            display: block; font-family: 'Consolas', monospace; font-size: 0.8rem; 
            color: var(--code-text); background: var(--code-bg); 
            padding: 6px 10px; border-radius: 4px; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            border: 1px solid var(--border-color);
        }
        
        .highlight { background: var(--highlight-bg); color: #000; padding: 1px 2px; border-radius: 2px; }

        button.exec-btn { 
            border: none; padding: 10px; border-radius: 6px; cursor: pointer; 
            font-weight: 600; width: 100%; 
            background: var(--accent-color); color: var(--btn-text); 
            transition: all 0.1s; 
        }
        button.exec-btn:active { transform: scale(0.96); }
        button.success { background: #81c784 !important; color: #fff !important; }
    </style>
</head>
<body class="light-mode">
    <div class="card">
        <header>
            <h1>üöÄ Windows Command Launcher <span id="count" style="font-size:0.8rem; background:rgba(128,128,128,0.1); padding:2px 8px; border-radius:10px; color:var(--text-sub); margin-left:10px;"></span></h1>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô Dark Mode</button>
        </header>
        <input type="text" id="search" placeholder="Emacs binds (Ctrl-a,e,f,b,h,d,k,u)..." autocomplete="off">
        <div class="table-container" id="container">
            <table id="mainTable"><tbody id="list"></tbody></table>
        </div>
    </div>

    <script>
        const data = MY_DATA_JSON;
        const ver = 'MY_TIMESTAMP';
        const input = document.getElementById('search');
        const listContainer = document.getElementById('list');
        const FAV_KEY = 'launcher_favorites';

        // --- „ÅäÊ∞ó„Å´ÂÖ•„ÇäÁÆ°ÁêÜ ---
        function getFavorites() {
            return JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
        }

        // ÂºïÊï∞„Åß„ÅØ„Å™„Åèevent„Åã„ÇâÂêçÂâç„ÇíÂèñÂæó„Åô„Çã„Çà„ÅÜ„Å´Â§âÊõ¥
        function toggleFavorite(e) {
            const star = e.currentTarget;
            const name = star.getAttribute('data-name');
            let favs = getFavorites();

            if (favs.includes(name)) {
                favs = favs.filter(f => f !== name);
            } else {
                favs.push(name);
            }
            localStorage.setItem(FAV_KEY, JSON.stringify(favs));
            render();
            e.stopPropagation(); // Ë¶™Ë¶ÅÁ¥†„Å∏„ÅÆ„ÇØ„É™„ÉÉ„ÇØ‰ºùÊí≠„ÇíÈò≤Ê≠¢
        }

        // --- „ÉÜ„Éº„ÉûÁÆ°ÁêÜ ---
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeUI(isDark);
        }
        function updateThemeUI(isDark) {
            document.getElementById('themeBtn').innerText = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            render();
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            updateThemeUI(true);
        }

        // --- Emacs„Ç≠„Éº„Éê„Ç§„É≥„Éâ ---
        input.addEventListener('keydown', function(e) {
            if (!e.ctrlKey) return;
            let h = true; const s = this.selectionStart;
            switch(e.key.toLowerCase()) {
                case 'a': this.setSelectionRange(0, 0); break;
                case 'e': this.setSelectionRange(this.value.length, this.value.length); break;
                case 'f': this.setSelectionRange(s + 1, s + 1); break;
                case 'b': this.setSelectionRange(s - 1, s - 1); break;
                case 'h': if (s > 0) { this.value = this.value.slice(0, s - 1) + this.value.slice(s); this.setSelectionRange(s - 1, s - 1); render(); } break;
                case 'd': this.value = this.value.slice(0, s) + this.value.slice(s + 1); this.setSelectionRange(s, s); render(); break;
                case 'k': this.value = this.value.slice(0, s); render(); break;
                case 'u': this.value = this.value.slice(s); this.setSelectionRange(0, 0); render(); break;
                default: h = false;
            }
            if (h) e.preventDefault();
        });

        input.addEventListener('input', render);
        window.addEventListener('resize', render);

        function highlight(t, q) {
            if(!q) return t;
            const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return t.replace(re, '<span class="highlight">$1</span>');
        }

        function render() {
            const q = input.value;
            const favs = getFavorites();

            let filtered = data.filter(d => 
                Object.values(d).some(v => String(v).toLowerCase().includes(q.toLowerCase()))
            );

            filtered = filtered.map(item => ({
                ...item,
                isFav: favs.includes(item.name)
            })).sort((a, b) => b.isFav - a.isFav);
            
            const containerHeight = document.getElementById('container').offsetHeight;
            const rowEstimatedHeight = 74; 
            const limit = Math.floor(containerHeight / rowEstimatedHeight);
            
            const display = filtered.slice(0, Math.max(limit, 1));
            document.getElementById('count').innerText = display.length + ' / ' + filtered.length;
            
            // HTML„ÇíÁîüÊàê
            listContainer.innerHTML = display.map(i => `
                <tr class="item-row">
                    <td>
                        <span class="fav-star ${i.isFav ? 'active' : ''}" data-name="${i.name.replace(/"/g, '&quot;')}">‚òÖ</span>
                        ${highlight(i.name, q)} 
                        <small style="color:var(--text-sub); font-weight:normal; margin-left:10px;">${highlight(i.remarks, q)}</small>
                    </td>
                    <td style="width:80px" rowspan="2"><button class="exec-btn" onclick="run(this, '${btoa(unescape(encodeURIComponent(i.command)))}')">ÂÆüË°å</button></td>
                </tr>
                <tr class="cmd-row"><td><code class="cmd-code">${highlight(i.command, q)}</code></td></tr>
            `).join('');

            // ÂêÑÊòü„Éû„Éº„ÇØ„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Çí‰∏ÄÊã¨ÁôªÈå≤ÔºàÂºïÁî®Á¨¶„Ç®„É©„Éº„ÇíÂÆåÂÖ®„Å´Èò≤„ÅêÔºâ
            document.querySelectorAll('.fav-star').forEach(star => {
                star.onclick = toggleFavorite;
            });
        }

        async function run(btn, c) {
            btn.classList.add('success');
            const oldText = btn.innerText;
            btn.innerText = 'OK';
            fetch('/run?cmd=' + c);
            setTimeout(() => { btn.classList.remove('success'); btn.innerText = oldText; }, 800);
        }

        setInterval(async () => {
            const r = await fetch('/check-reload?v=' + ver);
            if(await r.text() === 'reload') location.reload();
        }, 2000);
        
        render();
    </script>
</body>
</html>
